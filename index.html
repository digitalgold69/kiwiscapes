<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>See It Done — Visualiser</title>
<style>
:root{
  --bg:#0b0f14;--panel:#0f141b;--panel-2:#0b1118;--brand:#5b9dff;--brand-2:#87b6ff;
  --ok:#55d69e;--warn:#f0b232;--err:#ff6b6b;--ink:#dce6f2;--muted:#9fb3c8;--border:#1b2330;
  --glow:0 10px 30px rgba(91,157,255,.18);
}
body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:#fff;color:#000;line-height:1.6}
.container{max-width:980px;margin:0 auto;padding:20px}

header{position:sticky;top:0;background:#fff !important;border-bottom:1px solid #e8eef7 !important;z-index:50}
header *{color:#000 !important}

h1{font-size:1.9rem;margin:.25rem 0 .15rem}
p.lead{color:#374151}

.card{background:#fff;color:#000;border:1px solid #e8eef7;box-shadow:0 2px 8px rgba(18,32,56,.06);border-radius:16px;padding:18px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:0;border-radius:10px;padding:1rem 1.25rem;cursor:pointer;transition:.15s;font-size:1.25rem;font-weight:700;color:#000 !important}
.btn-primary{background:var(--brand);box-shadow:var(--glow)}
.btn-primary:hover{filter:brightness(1.05)}
.btn-ghost{background:transparent;border:1px solid #d6deea}

.field, input, textarea, select{
  width:100%;background:#fff;color:#111827;
  border:1px solid #d6deea;border-radius:10px;padding:1rem;box-shadow:none
}
input::placeholder,textarea::placeholder{color:#6b7280}
input:focus,textarea:focus,select:focus{
  outline:none;border-color:var(--brand,#3B82F6);box-shadow:0 0 0 4px rgba(59,130,246,.15)
}

.preview{width:100%;height:180px;background:#f8fafc;border:1px solid #e8eef7;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.preview img{max-width:100%;max-height:100%;object-fit:contain}
.result{width:100%;height:420px;background:#f8fafc;border:1px solid #e8eef7;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.result img{max-width:100%;max-height:100%;object-fit:contain}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.row{display:flex;gap:12px;flex-wrap:wrap}
.subtle{color:#6b7280;font-size:.95rem}

/* ---- HOW IT WORKS ---- */
.section-heading{font-size:1.25rem;font-weight:800;margin-bottom:.75rem;color:#000}
.how{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
@media (max-width:1023px){.how{grid-template-columns:1fr}}
.how .mini{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,.2)}
.how .mini img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#0b1118}
.how .mini,.how .mini *{color:#fff !important}

/* Loading bars */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:26px}
.bar{width:100%;height:3px;background:linear-gradient(90deg,var(--brand-2,#60A5FA),var(--brand,#3B82F6));background-size:180% 100%;animation:bar 1.2s linear infinite;border-radius:999px;opacity:.85}
@keyframes bar{0%{background-position:-120% 0}100%{background-position:120% 0}}

/* Toast */
.toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%) translateY(120%);background:#111827;border:1px solid #0b1118;padding:10px 16px;border-radius:10px;color:#fff;opacity:0;transition:.25s;z-index:1000}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.error{background:#ff6b6b;border-color:#e65252}

#progressBar{display:none !important}

/* Overlay spinner */
.loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(255,255,255,.85);z-index:2000}
.loading-overlay.show{display:flex}
.loader-spinner{width:56px;height:56px;border-radius:50%;border:4px solid #e5e7eb;border-top-color:var(--brand,#3B82F6);animation:sid-spin 1s linear infinite;margin-bottom:12px}
.loader-text{color:#111827}
@keyframes sid-spin{to{transform:rotate(360deg)}}

.logo-img{height:100px;display:none}
.logo-mark{width:50px;height:50px;border-radius:999px;background:radial-gradient(circle at 30% 30%,var(--brand),var(--brand-2))}
.brand{display:flex;align-items:center;gap:.6rem;cursor:pointer}

#sectionA .how .mini,
#sectionA .mini{background:var(--panel)!important;color:#fff!important;border:1px solid var(--border)!important}
#sectionA .how .mini img,
#sectionA .mini img{display:block;width:100%;height:auto!important;aspect-ratio:763/507;object-fit:cover;background:transparent!important;border-radius:10px;border:1px solid var(--border)}

/* Header & hero */
.header-content{display:flex;justify-content:center;align-items:center;padding:16px 0!important}
.brand-centered{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;text-align:center;margin:0 auto}
.logo-img{height:72px;display:none}
.logo-mark{width:48px;height:48px;border-radius:12px}
@media (max-width:640px){.brand-centered{flex-direction:column}}

.hero{background:linear-gradient(180deg,rgba(59,130,246,.08),rgba(59,130,246,0) 60%);border:1px solid #e8eef7;border-radius:16px;padding:18px 20px;margin:14px 0;text-align:center}

/* Upload CTA */
#uploadCTA .cta-center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
#uploadCTA .subtle{display:none!important} /* hide “JPG or PNG…” */

/* Footer */
.site-footer{margin:30px auto 10px;text-align:center;font-size:.9rem;color:#6b7280}
.site-footer a{color:inherit;text-decoration:underline}

/* CTA visibility:
   - visible ONLY on .is-home
   - hidden on .is-editing, .is-loading, .is-ready
*/
#uploadCTA{display:none}
.is-home #uploadCTA{display:block}
.is-editing #uploadCTA,
.is-loading #uploadCTA,
.is-ready   #uploadCTA{display:none}
</style>
</head>
<body>

<header>
  <div class="container header-content">
    <div class="brand brand-centered" id="brandHome">
      <img id="logoImg" class="logo-img" alt="Logo" />
      <div class="logo-mark" id="logoFallback"></div>
      <strong class="app-name" id="brandName">Odd Fellows Contracting</strong>
      <span class="pill" id="verticalPill">Kitchen Visualizer</span>
    </div>
  </div>
</header>

<main>
  <div class="container">
    <div class="content-narrow">

      <section class="hero">
        <h1 id="pageTitle">Visualise Your New Kitchen</h1>
        <p class="lead" id="pageSub">Upload a photo and preview changes in 60 seconds.</p>
      </section>

      <!-- Upload CTA -->
      <section id="uploadCTA" class="card" style="margin-top:14px">
        <div class="cta-center">
          <button class="btn btn-primary upload-btn" id="uploadBtn">
            <span class="btn-label">Upload an image of your <span id="areaWord2Label"></span></span>
          </button>
          <input id="fileInput" type="file" accept="image/*" hidden />
        </div>
      </section>

      <!-- A) HOW IT WORKS -->
      <section id="sectionA" class="card" style="margin-top:14px">
        <h3 class="how-title">How it works</h3>
        <div class="how">
          <div class="mini">
            <strong>1) Upload</strong>
            <img id="howImg1" alt="Step 1" loading="lazy" decoding="async" width="763" height="507" />
            <div>Upload an image of your <span id="areaWord1">kitchen</span>.</div>
          </div>
          <div class="mini">
            <strong>2) Describe</strong>
            <img id="howImg2" alt="Step 2" loading="lazy" decoding="async" width="763" height="507" />
            <div>Tell us what to change.</div>
          </div>
          <div class="mini">
            <strong>3) See it Done</strong>
            <img id="howImg3" alt="Step 3" loading="lazy" decoding="async" width="763" height="507" />
            <div>Get a photorealistic result.</div>
          </div>
        </div>
      </section>

      <!-- B) PROMPT DIALOG -->
      <section id="sectionB" class="card" style="display:none;margin-top:14px">
        <div class="preview"><img id="previewSmall" alt="Preview" /></div>

        <div class="row" style="margin:10px 0 6px">
          <button class="btn btn-ghost" id="changeImageBtn">Change image</button>
        </div>

        <div class="stack" style="margin-top:6px">
          <label>Describe your changes</label>
          <!-- placeholder set via CONFIG -->
          <textarea id="prompt2Input" class="field"></textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="generateNowBtn">Generate now</button>
        </div>
        <p class="subtle" style="margin-top:6px" aria-hidden="true"></p>
      </section>

      <!-- LOADING -->
      <section id="loadingPanel" class="card loading" style="display:none;margin-top:14px">
        <div class="bar"></div>
        <div class="bar" style="width:70%"></div>
        <div class="bar" style="width:40%"></div>
        <p class="subtle" id="loadingMessage">Processing your image…</p>
      </section>

      <!-- C) RESULT -->
      <section id="sectionC" class="card" style="display:none;margin-top:14px">
        <div class="result"><img id="resultImage" alt="Result" /></div>
        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="generateMoreBtn">Generate more</button>
        </div>

        <div class="grid2" style="margin-top:16px">
          <div class="row" style="flex-direction:column;gap:10px">
            <strong>Email me this</strong>
            <div class="row" style="align-items:center">
              <input id="emailInput" type="email" class="field" placeholder="you@example.com" />
              <button class="btn btn-ghost" id="emailSendBtn">Send</button>
            </div>
          </div>
          <div>
            <strong style="display:block;margin-bottom:6px">Original</strong>
            <div class="preview" style="height:260px"><img id="originalImage" alt="Original" /></div>
          </div>
        </div>
      </section>

      <footer class="site-footer">
        Powered by <a href="https://seeitdone.ai/ai-for-contractors/" target="_blank" rel="noopener">See it Done</a>
      </footer>

    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<div id="loadingOverlay" class="loading-overlay" aria-live="polite">
  <div class="loader-spinner"></div>
  <p class="loader-text">Processing your image… this can take up to 60 seconds.</p>
</div>

<script>
/************* CONFIG — EDIT PER BRAND *************/
const CONFIG = {
  BRAND_NAME: "Kiwiscapes",
  LOGO_URL: "https://scontent-lhr8-1.xx.fbcdn.net/v/t39.30808-6/295299219_744734090017986_6199590293080603021_n.jpg?_nc_cat=107&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=bJ8P4Z6IHqYQ7kNvwGHDC8n&_nc_oc=AdkKG5zVmWGwNBVRsS1vU6bfww69T8PKIxqVCbepDzZOF4wKCrvjktvTsCjEL-XrYGaJ_gxVdGTpnYgTH1NaZSk3&_nc_zt=23&_nc_ht=scontent-lhr8-1.xx&_nc_gid=ZuLUGCRlOFO4GuDQ6yayoQ&oh=00_AfbD8AK2Pu5GyjJP8ql58GlWRsqx_Vr6yadb80XCLjNztQ&oe=68D21AFA",
  TITLE: "Visualise Your New Garden",
  AREA_NOUN: "Garden",
  DEFAULT_AREA: "auto", // or "wall" / "all"
  PRIMARY: "#5d7749",
  ACCENT:  "#60A5FA",
  WORKER_URL: "https://seeitdone-demo.muddy-silence-4f5b.workers.dev",
  PRESET_PROMPT:
    "Landscape the garden per the user’s instructions. Keep the image photorealistic and true to the original. Change only what’s requested. No text or people. Preserve camera angle, lighting, materials, buildings, garden size, doors, windows, surroundings, and perspective.",
  HOW_STEP_IMAGES: [
    "https://i.ibb.co/tMB8NYM7/images-before-after-nov19-West-before.webp",
    "https://i.ibb.co/84zGpY6n/Add-a-subheading-2.png",
    "https://i.ibb.co/bjhDYjwH/eec17a04-71d0-4b16-aa23-f17b82b526cd.png"
  ],
  PROMPT_PLACEHOLDER: "Add a patio, plant some trees, and make the lawn greener.",
  REQUEST_TIMEOUT_MS: 180000,
  MAX_FILE_MB: 5,
  EMAIL: { enabled: false }
};

/************* STATE *************/
let currentFile = null;
let originalImageUrl = null;
let letterboxedDataUrl = null;
let origW = 0, origH = 0, scale = 1, finalWidth = 0, finalHeight = 0, paddedX = 0, paddedY = 0;
let resultRestoredUrl = null;

/************* ELEMS *************/
const $  = (s)=>document.querySelector(s);
const brandHome   = $('#brandHome');
const logoImg     = $('#logoImg');
const logoFallback= $('#logoFallback');
const brandName   = $('#brandName');
const pageTitle   = $('#pageTitle');
const pageSub     = $('#pageSub');
const verticalPill= $('#verticalPill');

const sectionA = $('#sectionA');
const sectionB = $('#sectionB');
const sectionC = $('#sectionC');
const loadingPanel = $('#loadingPanel');

const uploadBtn = $('#uploadBtn');
const fileInput = $('#fileInput');
const changeImageBtn = $('#changeImageBtn');

const prompt2Input = $('#prompt2Input');
const generateNowBtn = $('#generateNowBtn');

const resultImage   = $('#resultImage');
const originalImage = $('#originalImage');
const previewSmall  = $('#previewSmall');
const generateMoreBtn = $('#generateMoreBtn');

const emailInput = $('#emailInput');
const emailSendBtn = $('#emailSendBtn');

const howImg1 = $('#howImg1');
const howImg2 = $('#howImg2');
const howImg3 = $('#howImg3');

const toast = $('#toast');
const loadingOverlay = document.getElementById('loadingOverlay');

/************* HERO STATE (controls CTA visibility) *************/
function setHeroState(state) {
  const titleEls = document.querySelectorAll('#pageTitle, .hero h1');
  const subEls   = document.querySelectorAll('#pageSub, .hero .lead');
  const setText  = (els, text)=> els.forEach(el => { if (el) el.textContent = text; });

  document.body.classList.remove('is-home','is-editing','is-loading','is-ready');

  if (state === 'home') {
    document.body.classList.add('is-home');
    setText(titleEls, CONFIG.TITLE);
    setText(subEls, 'Upload a photo and preview changes in 60 seconds.');
    return;
  }
  if (state === 'editing') {
    document.body.classList.add('is-editing');
    setText(titleEls, 'Describe your changes');
    setText(subEls, '');
    return;
  }
  if (state === 'loading') {
    document.body.classList.add('is-loading');
    setText(titleEls, 'Our AI fairys are working on your image!');
    setText(subEls, '');
    return;
  }
  if (state === 'ready') {
    document.body.classList.add('is-ready');
    setText(titleEls, 'Your Image is Ready');
    setText(subEls, '');
    return;
  }
}

/************* BRANDING *************/
(function initBranding(){
  // Colors
  document.documentElement.style.setProperty('--brand',  CONFIG.PRIMARY);
  document.documentElement.style.setProperty('--brand-2',CONFIG.ACCENT);

  // Text
  brandName.textContent = CONFIG.BRAND_NAME;
  pageTitle.textContent = CONFIG.TITLE;
  pageSub.textContent   = "Upload a photo and preview changes in 60 seconds.";
  verticalPill.textContent = `${CONFIG.AREA_NOUN} Visualizer`;

  // Nouns
  const noun = (CONFIG.AREA_NOUN || 'Kitchen').toLowerCase(); // fallback only
  const el2 = document.getElementById('areaWord2Label'); if (el2) el2.textContent = noun;
  const el1 = document.getElementById('areaWord1');     if (el1) el1.textContent = noun;

  // Prompt placeholder
  const promptBox = document.getElementById('prompt2Input');
  if (promptBox && CONFIG.PROMPT_PLACEHOLDER) {
    promptBox.placeholder = CONFIG.PROMPT_PLACEHOLDER;
  }

  // Logo
  if (CONFIG.LOGO_URL){
    logoImg.src = CONFIG.LOGO_URL;
    logoImg.style.display = 'block';
    logoFallback.style.display = 'none';
  }

  // How it works images
  [howImg1, howImg2, howImg3].forEach((el, i)=>{
    const url = CONFIG.HOW_STEP_IMAGES?.[i];
    if (url){ el.src = url; el.style.display = 'block'; }
  });

  // Start in home state so CTA is visible
  setHeroState('home');
})();

/************* HELPERS *************/
function show(section){
  [sectionA, sectionB, sectionC, loadingPanel].forEach(el=>el.style.display='none');
  section.style.display = 'block';
}
function showToast(msg, type){
  toast.textContent = msg;
  toast.className = 'toast' + (type==='error' ? ' error' : '');
  requestAnimationFrame(()=> toast.classList.add('show'));
  setTimeout(()=> toast.classList.remove('show'), 2500);
}
function resetToStart(){
  prompt2Input.value = '';
  if (originalImageUrl) { URL.revokeObjectURL(originalImageUrl); }
  fileInput.value = '';
  currentFile = null;
  originalImageUrl = null;
  letterboxedDataUrl = null;
  resultRestoredUrl = null;

  previewSmall.removeAttribute('src');
  resultImage.removeAttribute('src');
  originalImage.removeAttribute('src');

  show(sectionA);
  setHeroState('home');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showLoadingOverlay(msg){
  if (!loadingOverlay) return;
  const p = loadingOverlay.querySelector('.loader-text');
  if (p && msg) p.textContent = msg;
  loadingOverlay.classList.add('show');
}
function hideLoadingOverlay(){
  if (!loadingOverlay) return;
  loadingOverlay.classList.remove('show');
}

/************* IMAGE HANDLING (LETTERBOX 1024) *************/
async function handleFileSelect(e){
  const file = e?.target?.files?.[0];
  if (!file) return;

  if (!/^image\//.test(file.type)) return showToast('Please select an image file','error');
  if (file.size > CONFIG.MAX_FILE_MB * 1024 * 1024) return showToast(`File exceeds ${CONFIG.MAX_FILE_MB}MB`,'error');

  currentFile = file;
  if (originalImageUrl) URL.revokeObjectURL(originalImageUrl);
  originalImageUrl = URL.createObjectURL(file);

  const img = new Image();
  img.onload = ()=>{
    origW = img.naturalWidth; origH = img.naturalHeight;

    const canvas = document.createElement('canvas');
    canvas.width = 1024; canvas.height = 1024;
    const ctx = canvas.getContext('2d');

    scale = Math.min(1024 / origW, 1024 / origH);
    finalWidth  = Math.round(origW * scale);
    finalHeight = Math.round(origH * scale);
    paddedX = Math.round((1024 - finalWidth) / 2);
    paddedY = Math.round((1024 - finalHeight) / 2);

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.clearRect(0,0,1024,1024);
    ctx.drawImage(img, paddedX, paddedY, finalWidth, finalHeight);

    letterboxedDataUrl = canvas.toDataURL('image/png', 1.0);

    previewSmall.src = originalImageUrl;
    show(sectionB);
    setHeroState('editing'); // hide upload CTA after selecting a file
  };
  img.onerror = ()=> showToast('Could not read image','error');
  img.src = originalImageUrl;
}

/************* GENERATE (MASK ➜ INPAINT ➜ RESTORE) *************/
async function generateNow(){
  if (!currentFile){
    showToast(`Upload a ${CONFIG.AREA_NOUN.toLowerCase()} photo first`,'error');
    return;
  }

  const userDetail = (prompt2Input.value || '').trim();
  if (!userDetail){
    showToast('Please describe your changes','error');
    return;
  }

  const areaToEdit = (
    CONFIG.DEFAULT_AREA && CONFIG.DEFAULT_AREA !== 'auto'
      ? CONFIG.DEFAULT_AREA
      : (CONFIG.AREA_NOUN || 'kitchen')
  ).toLowerCase();

  const combinedPrompt =
    `${CONFIG.PRESET_PROMPT}\n\n` +
    `Brand: ${CONFIG.BRAND_NAME}\n` +
    `Vertical: ${CONFIG.AREA_NOUN}\n` +
    `User request: ${userDetail}`;

  setHeroState('loading');
  show(loadingPanel);
  document.getElementById('loadingMessage').textContent =
    'Please be patient, the AI can take up to 60 seconds to process your image.';

  const ctrl = new AbortController();
  const kill = setTimeout(()=> ctrl.abort(), CONFIG.REQUEST_TIMEOUT_MS);

  try {
    const maskRes = await fetch(`${CONFIG.WORKER_URL}/generate-mask`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        imageBase64: letterboxedDataUrl,
        areaToEdit,
        imageMetadata: { origW, origH, finalWidth, finalHeight, paddedX, paddedY, scale }
      }),
      signal: ctrl.signal
    });
    if (!maskRes.ok){
      const err = await maskRes.json().catch(()=>({}));
      throw new Error(err.error || err.message || 'Mask generation failed');
    }
    const { maskBase64 } = await maskRes.json();
    if (!maskBase64) throw new Error('No mask returned from server');

    const paintRes = await fetch(`${CONFIG.WORKER_URL}/inpainting`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        prompt: combinedPrompt,
        init_image: letterboxedDataUrl,
        mask_image: maskBase64
      }),
      signal: ctrl.signal
    });
    if (!paintRes.ok){
      const err = await paintRes.json().catch(()=>({}));
      throw new Error(err.error || err.message || 'Inpainting failed');
    }
    const paintJson = await paintRes.json();
    if (!paintJson.images || !paintJson.images[0]) throw new Error('No image returned from inpainting');
    const result1024 = `data:image/png;base64,${paintJson.images[0]}`;

    const out = new Image();
    out.onload = ()=>{
      const c = document.createElement('canvas');
      c.width = origW; c.height = origH;
      const ctx = c.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(out, paddedX, paddedY, finalWidth, finalHeight, 0, 0, origW, origH);
      resultRestoredUrl = c.toDataURL('image/png', 1.0);

      resultImage.src = resultRestoredUrl;
      originalImage.src = originalImageUrl;
      show(sectionC);

      setHeroState('ready');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast('Image generated successfully!');
    };
    out.onerror = ()=> { throw new Error('Failed to decode result image'); };
    out.src = result1024;

  } catch (err) {
    show(sectionB);
    setHeroState('home');
    showToast(err.message || 'Something went wrong','error');
  } finally {
    clearTimeout(kill);
  }
}

/************* EMAIL (placeholder) *************/
async function emailResult(){
  const email = (emailInput.value||'').trim();
  if (!email) return showToast('Enter your email first','error');
  showToast('We’ll email your images shortly.');
}

/************* EVENTS *************/
uploadBtn.addEventListener('click', ()=> fileInput.click());
changeImageBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', handleFileSelect);
generateNowBtn.addEventListener('click', generateNow);
generateMoreBtn.addEventListener('click', resetToStart);
brandHome.addEventListener('click', resetToStart);
emailSendBtn.addEventListener('click', emailResult);

/************* STATUS PING (optional) *************/
(async function ping(){
  try{
    const r = await fetch(`${CONFIG.WORKER_URL}/`, {method:'GET'});
    console.debug('API status:', r.ok ? 'connected' : 'error');
  } catch{
    console.debug('API status: unreachable');
  }
})();
</script>
</body>
</html>
